<!DOCTYPE html>
<html>
	<head>
		<meta name='viewport' id='viewport' content='width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no'/>
		<meta charset='UTF-8'/>
		<title>Japanese Kanji Readings</title>
		<script type='text/javascript' src='js/underscore-min.js'></script>
		<style type='text/css'>
body{
	margin:0;
	padding:0;
	width:100%;
	box-sizing:border-box;
	-webkit-box-sizing:border-box;
	-moz-box-sizing:border-box;
	color:#562135;
	background-color:#ffe7de;
}
.main-input{
	margin:0;
	padding:10px;
	height:24px;
	background-color:#c3829e;
}
#kanji_search{
	width:calc(100% - 10px);
	margin:0;
	padding:0 5px;
	line-height:24px;
	border:none;
	color:#562135;
	background:#ffe7de;
}
#kanji_search:-webkit-autofill,#kanji_search:-webkit-autofill:focus{
	-webkit-box-shadow:0 0 0px 1000px #ffe7de inset!important;
	-webkit-text-fill-color:#562135;
}
.frame-result{
	padding:10px;
}
.frame-result h3{
	padding:0;
	margin:0;
}
hr{
	border:none;
	border-top:1px solid #e9b1cd;
	margin:0;
	padding:0;
}
.record-sep{
	margin:6px 0 10px 0;
}

.frame-loading {
	background:#ffe7de;
	display:none;
	padding:0 5px;
	line-height:24px;
	position:relative;
}
.frame-loading .loading-text{
	position:relative;
	color:#c3829e;
	z-index:10;
}
.frame-loading .loading-progress{
	position:absolute;
	left:0;top:0;
	height:24px;
	width:0;
	background:#562135;
}
body[loading] #kanji_search{
	display:none;
}
body[loading] #show_loading{
	display:block;
}
		</style>
	</head>
	<body loading='loading'>
		<div class='main-input'>
			<div class='frame-loading' id='show_loading'>
				<div class='loading-text'>Loading...</div>
				<div class='loading-progress' id='loading_progress'></div>
			</div>
			<input type='text' id='kanji_search' placeholder='Input Kanji'/>
		</div>
		<div class='frame-result' id='show_result'></div>
	</body>
	<script type='text/template' id='show_result_template'>
<% for (var i = 0; i < data.length; i++) { %>
	<% var kanjiData = data[i];%>
	<h3><%-kanjiData.kanji%></h3>
	<table>
		<% if (kanjiData.on) { %>
			<tr><td>On Reading:</td><td><%-kanjiData.on.join(', ')%></td></tr>
		<% } %>
		<% if (kanjiData.kun) { %>
			<tr><td>Kun Reading:</td><td><%-kanjiData.kun.join(', ')%></td></tr>
		<% } %>
	</table>
	<% if (i+1 < data.length) { %>
		<hr class='record-sep'/>
	<% } %>
<% } %>
	</script>
	<script>
function KanjiReading(data) {
	var kanjiData = data;
	this.getFromText = function(text) {
		if ('string' !== typeof text) {
			return undefined;
		}
		var dupCharChecker = {};
		var result = [];
		for (var i = 0; i < text.length; i++) {
			var kanji = text.charAt(i);
			var kanjiCode = text.charCodeAt(i).toString(16).toUpperCase();
			var kanjiReading = kanjiData[kanjiCode];
			if (kanjiReading && !dupCharChecker[kanji]) {
				dupCharChecker[kanji] = true;
				result.push({
					kanji:kanji,
					on:kanjiReading.on,
					kun:kanjiReading.kun,
				});
			}
		}
		return result;
	}
}
	</script>
	<script>
'use strict'
var kanjiReading = undefined;
var displayKanjiReading = _.template(document.getElementById('show_result_template').innerHTML);

var kanji_search = document.getElementById('kanji_search');
var show_result = document.getElementById('show_result');
var loading_progress = document.getElementById('loading_progress');
kanji_search.addEventListener('input', _.throttle(function(e){
	if (undefined === kanjiReading) {
		return;
	}
	show_result.innerHTML = displayKanjiReading({data:kanjiReading.getFromText(kanji_search.value)});
}, 100));

var xhr=new XMLHttpRequest();
xhr.addEventListener('readystatechange', function(){
	if (this.readyState == 4 && this.status == 200) {
		kanjiReading = new KanjiReading(JSON.parse(this.responseText));
		document.body.removeAttribute('loading');
	}
});
var timestamp = _.now();
xhr.addEventListener('progress', _.throttle(function(e){
	var now = _.now();
	loading_progress.style.width=Math.round(e.loaded/e.total*100)+'%';
	loading_progress.style.transition='width '+Number((now-timestamp)/1000)+'s';
	timestamp = now;
}, 50));
xhr.open('GET', 'readings.json');
xhr.send();
	</script>
</html>

